---
title: "FlowUti"
author: 
date: 
output: html_document
header-includes: \usepackages[spanish,es-tabla]{babel}
                 \decimalpoint
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(shiny)
library(foreign)
library(ggplot2)
library(nortest)
library(dplyr)
library(gridExtra)
library(rms)
library(ggthemr)
library(ggfortify)
library(shinysky)
library(openintro)
library(plotrix)
library(effects)
library(plotROC)
library(xtable)
library(data.table)
library(pROC)
library(epiR)
library(DT)
library(shinythemes)

```

*`r as.character(format(Sys.Date(), format="%B %d, %Y"))`*  

#####File: `r if (is.null(input$file)) {paste("Demo")} else{input$file[1]}`  

#####Marker: `r input$vdecorte`.  

#####Gold estandar: `r input$gold`.  


###1. The area under the ROC curve (AUC)


```{r include=TRUE,echo=FALSE}
abc<-roc(Dataset()[,input$gold],Dataset()[,input$vdecorte])
aabc<-auc(abc)
laabc<-ci.auc(abc)

```
 The area under the curve is **`r round(auc(abc),4)`**;  confidence interval (95%) **`r round(laabc[1],4)`** y **`r round(laabc[3],4)`**.  

```{r include=TRUE, echo=FALSE, fig.align='center', fig.height=4.5, fig.width=5.5}
#g1<-plot.roc(abc,print.auc=TRUE,auc.polygon=TRUE, grid=c(0.1, 0.2),
           #grid.col=c("green", "red"), max.auc.polygon=TRUE,
           #auc.polygon.col="gainsboro",main="Curva ROC")
#g2<-plot.roc(smooth(abc),add=TRUE, col="blue")
cr<-roc(Dataset()[,input$gold],Dataset()[,input$vdecorte])
  textlab<-paste("AUC =",round(auc(cr),3))
  df = data.frame(fp=1-cr$specificities, vp=cr$sensitivities)
  tmp <- data.frame(fp=c(0, 1, 1), vp=c(0, 1, 0)) 
  ggplot(data = df, aes(x =fp , y = vp)) +   geom_path(colour = 'navy', size = 1.5)+
    ylab('Sensitivity') + xlab('1-specificity') +
    ggtitle("ROC curve")+
    geom_polygon( data= df, aes(x=fp, y=vp), fill="gray70",alpha = 0.6) +
    geom_polygon(data=tmp, aes(fp, vp), fill="gray70",alpha = 0.6) +
    geom_segment(aes(x=0,y=0,xend=1,yend=1),lty=2,col="gray50", alpha = 0.3)+
    annotate("text", x = .70, y = .35, label = textlab, size = 5)
```
  
###2. Diagnostic accuracy.  
####For a cutoff point of `r input$corte`  `r input$vdecorte`: 

```{r include=TRUE, echo=FALSE}
   corte<-input$corte
      ts <- subset(Dataset(), subset=Dataset()[,input$vdecorte]>=corte)
      ti<-subset(Dataset(), subset=Dataset()[,input$vdecorte]<corte)
      
      .Tablea <- with(ts, table(ts[,input$gold]))
      vp<-.Tablea[2]
      fp<-.Tablea[1]
      
      .Tableb <- with(ti, table(ti[,input$gold]))
      vn<-.Tableb[1]
      fn<-.Tableb[2]
      
      vp1<-vp
      fn1<-fn
      fp1<-fp
      vn1<-vn
      dat <- as.table(matrix(c(vp1,fp1,fn1,vn1), nrow = 2, byrow = TRUE))
      rval <- epi.tests(dat, conf.level = 0.95)
```
The proportion of false positives is `r 100-(round(rval$specificity$est,3))*100`% and he proportion of false negatives is `r 100-(round(rval$sensitivity$est,3))*100`%.  

####Sensitivity 
The sensitivity is  **`r round(rval$sensitivity$est,3)*100`%**.   

####Specificity  
The specificity is **`r round(rval$specificity$est,3)*100`%**.   

####Positive predictive value 

The probability of suffering an UTI if you select   `r input$corte`  `r input$vdecorte` or more, is **`r round(rval$pv.positive$est,3)*100`%**.    

####Negative predictive value  
The probability that a subject with a negative test result (less than `r input$corte`  `r input$vdecorte`) is really healthy, is **`r round(rval$pv.negative$est,3)*100`%**.   

####Diagnostic accuracy (effectiveness) 
The probability that the diagnostic test correctly classifies patients is  **`r round(rval$diag.acc$est,3)*100`%**.    

#### Diagnostic Odds ratio  
The DOR is  **`r round(rval$diag.or$est,3)`**.  

####Youden's index  
Youden's index is **`r round(rval$youden$est,3)`**.  

####Likelihood ratio for positive test  
The probability of obtaining `r input$corte`   `r input$vdecorte` or more in a patient with UTI versus a healthy one is `r round(rval$lr.positive$est,3)` times higher.  

####Likelihood ratio for negative test
The probability of finding a negative result (less than `r input$corte`  `r input$vdecorte`) in a patient with UTI versus a healthy one is `r round(1/(rval$lr.negative$est),3)` times smaller. 
  
###3. Summary table for `r input$corte`  `r input$vdecorte`

```{r include=TRUE, echo=FALSE ,results='asis'}
col11<-c("Sensitivity","Specificity","Proportion of false positives","Proportion of false negatives",
               "Positive predictive value","Negative predictive value","Diagnostic accuracy (effectiveness)",
               "Diagnostic odds ratio","Youden's index","Likelihood ratio for positive test","Likelihood ratio for negative test")
      col21<-c(rval$sensitivity$est,rval$specificity$est,
               1-rval$specificity$est,1-rval$sensitivity$est,
               rval$pv.positive$est,rval$pv.negative$est,
               rval$diag.acc$est,rval$diag.or$est,rval$youden$est,
               rval$lr.positive$est,rval$lr.negative$est)
      col31<-c(rval$sensitivity$lower,rval$specificity$lower,1-rval$specificity$upper,
               1-rval$sensitivity$upper,rval$pv.positive$lower,rval$pv.negative$lower,
               rval$diag.acc$lower,rval$diag.or$lower,rval$youden$lower,rval$lr.positive$lower,
               rval$lr.negative$lower)
      col41<-c(rval$sensitivity$upper,rval$specificity$upper,1-rval$specificity$lower,
               1-rval$sensitivity$lower,rval$pv.positive$upper,rval$pv.negative$upper,
               rval$diag.acc$upper,rval$diag.or$upper,rval$youden$upper,rval$lr.positive$upper,
               rval$lr.negative$upper)
      ret1<-as.data.frame(cbind(col11,col21,col31,col41))
      ret1$col21<-round(as.numeric(as.character(ret1$col21)),3)
      ret1$col31<-round(as.numeric(as.character(ret1$col31)),3)
      ret1$col41<-round(as.numeric(as.character(ret1$col41)),3)
      colnames(ret1)<-c("Measure","Value","CI low","CI up")
      #list(ret1)
```

`r kable(ret1)`    



    
    
  
```{r include=TRUE, echo=FALSE, fig.align='center', fig.height=4.5, fig.width=5.5,warning=FALSE}

corte=input$corte
        
        ggplot(Dataset(),aes(Dataset()[,input$vdecorte],fill=Dataset()[,input$gold]))+
        geom_density(alpha=0.55)+
          xlim(0,input$smax)+
        geom_vline(xintercept = corte,col=2)+
        labs(x=input$vdecorte,y="Density",title=paste("Density plot with threshold  ",corte,input$vdecorte))+
        theme(legend.position="top")+
        scale_fill_discrete(name=input$gold)+
        theme(axis.text.y=element_text( size=12, vjust=0.5),
              plot.title = element_text(size = 12),axis.text.x=element_text( size=12, 
              vjust=0.5), axis.title.x=element_text( size=12, vjust=0.5),
              axis.title.y=element_text( size=12, vjust=0.5))+
        theme(legend.text = element_text(size = 10))
```








